#!/bin/sh

usage() {
  echo ""
  echo "Usage: bldw project webPropFile [-publishDocs]"
  echo ""
  echo "Example:  bldw GiardiaDBWebsite project_home/webapp.prop"
  echo ""
  echo "  calls 'build GiardiaDBWebsite webinstall -append -webPropFile project_home/webapp.prop'"
  echo ""
  echo "The -publishDocs flag, if present, will be passed to build as well"
  exit 1
}

if [ "$#" != "2" ]; then
  if [ "$3" != "-publishDocs" ]; then
    usage
  elif [ "$#" != "3" ]; then
    usage
  fi
fi

# ensure generated webPropFile has a place to live
gusHomeParent="$(dirname $GUS_HOME)"
mkdir -p $gusHomeParent/etc

# define locations
webPropTemplate=$(dirname "$0")/../config/webapp.prop.tmpl
webPropFile=$gusHomeParent/etc/webapp.prop.generated

# make default webPropFile from the template
sed "s|<siteDir>|$gusHomeParent|g" $webPropTemplate > $webPropFile

echo "Created webPropFile from template: $webPropFile"

webPropFileArg=$2
if ! [ -e $webPropFileArg ]; then
  echo "$webPropFileArg does not exist"
  exit 2
fi

# clean input file and cat it onto the end of the generated file
echo "Adding site-specific web props to generated webPropFile: $webPropFile"
grep -v 'TargetDir=' $webPropFileArg >> $webPropFile

# build with the resulting file
build $1 webinstall -append -installConfigFile -webPropFile $webPropFile $3
